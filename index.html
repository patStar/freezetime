<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script language="javascript">
//pragma strict
function arrayContains(needle, haystack) { return haystack.indexOf(needle) > -1; }
function arrayRemove(needle, haystack) {if(arrayContains(needle, haystack)) {return haystack.splice(haystack.indexOf(needle),1); } return null; }
Array.prototype.rnd = function() {return this[Math.floor(this.length*Math.random())];}
function p(x,y) {return {x:x,y:y};}
function img(src) {
	var im = new Image(); 
	im.src =src; 
	return im;	
}
function w(x) {return Math.floor(Math.random()*x)}

function AnimatedSprite(image,frames){
	var currentFrame = 0;
	this.tick = function(){
		currentFrame = (currentFrame+1)%frames.length
	}	
	this.draw =function (ctx,bounding){
		var frame = frames[currentFrame];		
		ctx.drawImage(image,frame.x,frame.y,frame.width,frame.height,bounding.x,bounding.y,bounding.width,bounding.height)
	}
}
AnimatedSprite.all = {};

function MouseListener(){}
MouseListener.onMouseDown = function(evt){	
	for(var i=0; i<MouseListener.registeredClients.mouseDown.length; i++){
		MouseListener.registeredClients.mouseDown[i].notify(MouseListener.MOUSE_DOWN,evt);
	}
}
MouseListener.onMouseMove = function(evt){
	for(var i=0; i<MouseListener.registeredClients.mouseMove.length; i++){
		MouseListener.registeredClients.mouseMove[i].notify(MouseListener.MOUSE_MOVE,evt);
	}
}
MouseListener.MOUSE_MOVE = "mouseMove"
MouseListener.MOUSE_DOWN = "mouseDown"
MouseListener.registeredClients = {
	mouseDown : [],
	mouseMove : [],
}

function createCanvas(width ,height, mouseListener, id) 
{ 
	var canvas = document.createElement('canvas'); 
	canvas.id = id;
	canvas.width = width; 
	canvas.height= height; 
	if(mouseListener){
		canvas.onmousedown = mouseListener.onMouseDown
		canvas.onmousemove = mouseListener.onMouseMove
	}
	return canvas;
}

function MapField(type){
	this.type = type	
	this.unit = Units.EMPTY
}

function Map(width,height){
	var map = [];
	for(var y=0; y<height; y++){
		map.push([]);
		for(var x=0; x<width; x++){
			map[y].push(new MapField(0));
		}
	}
	
	this.getRightField = function(direction, x, y){
		var rightDirection = DIRECTION.turnRight(direction);
		return this.get(x+rightDirection.x,y+rightDirection.y)
	}
	
	this.getLeftField = function(direction, x, y){
		var rightDirection = DIRECTION.turnLeft(direction);
		return this.get(x+rightDirection.x,y+rightDirection.y)	
	}
		
	this.get = function(x,y){
		return map[(height+(y%height))%height][(width+(x%width))%width];
	}
	
	this.width = function(){
		return width;
	}
	
	this.height = function(){
		return height;
	}
}

var DIRECTION = new Object();
DIRECTION.N = p(0,-1);
DIRECTION.E = p(1,0);
DIRECTION.W = p(-1,0);
DIRECTION.S = p(0,1);	
DIRECTION.order = [DIRECTION.N,DIRECTION.E,DIRECTION.S,DIRECTION.W];
DIRECTION.turnAround = function(direction) {return DIRECTION.turn(direction,2)}
DIRECTION.turnLeft = function(direction) {return DIRECTION.turn(direction,-1)}
DIRECTION.turnRight = function(direction) {return DIRECTION.turn(direction,1)}
DIRECTION.turn = function(direction, delta){
	var index = DIRECTION.order.indexOf(direction)	
	if(index == -1) return null;		
	return DIRECTION.order[(DIRECTION.order.length+index+delta)%DIRECTION.order.length]
};

var lakeTiles = [9,100,110,120,130,140,150,160,170,180,190,200,210,10,11,12,13,14,15,16,17,18,19,20,21,22]
var snowStorm = 8+w(21);
function MapDrawer(ctx, map, stepManager){

	this.xShift = 0;
	this.yShift = 0;
	
	this.currentMousePosition = null

	this.notify = function(topic, evt){
		var x = Math.floor((evt.pageX-gameCanvas.offsetLeft)/16)
		var y = Math.floor((evt.pageY-gameCanvas.offsetTop)/16)
		if(!(x >= 0 && x < map.width() && y >= 0 && y < map.height())){
			this.currentMousePosition = null;
			return
		}
		
		if(topic == MouseListener.MOUSE_DOWN){			
			
		}else if(topic == MouseListener.MOUSE_MOVE){
			this.currentMousePosition = p(x,y)
		}		
	}

	this.draw = function(){
		ctx.fillRect(0,0,WIDTH,HEIGHT)		
		ctx.fillStyle="grey"
		ctx.translate(Game.player.mapShift.x,Game.player.mapShift.y)
		for(var ys=-16; ys<12; ys++){
			for(var xs=-16; xs<12; xs++){
				var field = map.get(Game.player.position.x+xs,Game.player.position.y+ys)					
				if(field.type == 70) continue;
				var x = 10+xs
				var y = 10+ys				
				var X,Y;
				if(field.type == 0){
					X=types.ground.x*8;
					Y=types.ground.y*8;
				}else if(field.type == 2){
					X=types.tree1.x*8;
					Y=types.tree1.y*8;
				}else if(field.type == 3){
					X=types.tree2.x*8;
					Y=types.tree2.y*8;
				}else if(field.type == 4){
					X=types.tree3.x*8;
					Y=types.tree3.y*8;
				}else if(field.type == 5){
					X=types.tree4.x*8;
					Y=types.tree4.y*8;
				}else if(field.type == 6){
					X=types.grass.x*8;
					Y=types.grass.y*8;
				}else if(field.type == 7){
					X=types.house.x*8;
					Y=types.house.y*8;
				}else if(field.type == 8){
					X=types.hole.x*8;
					Y=types.hole.y*8;
				}else if(field.type == 9){
					X=types.see.x*8;
					Y=types.see.y*8;
				}else if(field.type == 10){
					X=types.see_n_w.x*8;
					Y=types.see_n_w.y*8;
				}else if(field.type == 11){
					X=types.see_n_e.x*8;
					Y=types.see_n_e.y*8;
				}else if(field.type == 12){
					X=types.see_s_w.x*8;
					Y=types.see_s_w.y*8;
				}else if(field.type == 13){
					X=types.see_s_e.x*8;
					Y=types.see_s_e.y*8;
				}else if(field.type == 14){
					X=types.see_w.x*8;
					Y=types.see_w.y*8;
				}else if(field.type == 15){
					X=types.see_e.x*8;
					Y=types.see_e.y*8;
				}else if(field.type == 16){
					X=types.see_e_x.x*8;
					Y=types.see_e_x.y*8;
				}else if(field.type == 17){
					X=types.see_w_x.x*8;
					Y=types.see_w_x.y*8;
				}else if(field.type == 18){
					X=types.see_n_x.x*8;
					Y=types.see_n_x.y*8;
				}else if(field.type == 19){
					X=types.see_s_x.x*8;
					Y=types.see_s_x.y*8;
				}else if(field.type == 20){
					X=types.see_sn_x.x*8;
					Y=types.see_sn_x.y*8;
				}else if(field.type == 21){
					X=types.see_we_x.x*8;
					Y=types.see_we_x.y*8;
				}else if(field.type == 22){
					X=types.single_lake.x*8;
					Y=types.single_lake.y*8;
				}else if(field.type == 30){
					X=types.ground_2.x*8;
					Y=types.ground_2.y*8;
				}else if(field.type == 31){
					X=types.ground_3.x*8;
					Y=types.ground_3.y*8;
				}else if(field.type == 32){
					X=types.ground_4.x*8;
					Y=types.ground_4.y*8;
				}else if(field.type == 40){
					X=types.ruin.x*8;
					Y=types.ruin.y*8;
				}
				else if(field.type == 61){
					X=types.grass_2.x*8;
					Y=types.grass_2.y*8;
				}else if(field.type == 62){
					X=types.grass_3.x*8;
					Y=types.grass_3.y*8;
				}else if(field.type == 63){
					X=types.grass_4.x*8;
					Y=types.grass_4.y*8;
				}else if(field.type == 64){
					X=types.grass_5.x*8;
					Y=types.grass_5.y*8;
				}
				else if(field.type == 100){
					X=types.see_n_w.x*8;
					Y=(1+types.see_n_w.y)*8;
				}else if(field.type == 110){
					X=types.see_n_e.x*8;
					Y=(1+types.see_n_e.y)*8;
				}else if(field.type == 120){
					X=types.see_s_w.x*8;
					Y=(1+types.see_s_w.y)*8;
				}else if(field.type == 130){
					X=types.see_s_e.x*8;
					Y=(1+types.see_s_e.y)*8;
				}else if(field.type == 140){
					X=types.see_w.x*8;
					Y=(1+types.see_w.y)*8;
				}else if(field.type == 150){
					X=types.see_e.x*8;
					Y=(1+types.see_e.y)*8;;
				}else if(field.type == 160){
					X=types.see_e_x.x*8;
					Y=(1+types.see_e_x.y)*8;
				}else if(field.type == 170){
					X=types.see_w_x.x*8;
					Y=(1+types.see_w_x.y)*8;
				}else if(field.type == 180){
					X=types.see_n_x.x*8;
					Y=(1+types.see_n_x.y)*8;
				}else if(field.type == 190){
					X=types.see_s_x.x*8;
					Y=(1+types.see_s_x.y)*8;
				}else if(field.type == 200){
					X=types.see_sn_x.x*8;
					Y=(1+types.see_sn_x.y)*8;
				}else if(field.type == 210){
					X=types.see_we_x.x*8;
					Y=(1+types.see_we_x.y)*8;
				}
				
				if(arrayContains(field.type,lakeTiles)){					
					ctx.drawImage(sprites,types.see.x*8,types.see.y*8,8,8,32*x,32*y,32,32)																							
					if(xs==0 && ys==1){					
						if(Game.player.moving && (arrayContains(map.get(Game.player.position.x+xs,Game.player.position.y+ys-1).type,lakeTiles) || Game.player.movingDirection.y != -1) && (arrayContains(map.get(Game.player.position.x+xs-1,Game.player.position.y+ys).type,lakeTiles) || Game.player.movingDirection.x != -1) && (arrayContains(map.get(Game.player.position.x+xs+1,Game.player.position.y+ys).type,lakeTiles) || Game.player.movingDirection.x != 1)){				
							ctx.drawImage(sprites,types.mirror_man.x*8,types.mirror_man.y*8,8,8,32*10-Game.player.mapShift.x,32*11-Game.player.mapShift.y,32,32)								
						}else{
							ctx.drawImage(sprites,types.mirror_man.x*8,types.mirror_man.y*8,8,8,32*x,32*y,32,32)	
						}
					}			
				}
				
				if(field.type != 9 && field.type != 7) {
					ctx.drawImage(sprites,X,Y,8,8,32*x,32*y,32,32)																		
				}else if(field.type == 7){
					if(field.houseLength == 3){
						ctx.drawImage(sprites,types.hutStart.x*8,types.hutStart.y*8,8,8*2,32*x,32*y,32,32*2)																		
						ctx.drawImage(sprites,(types.hutStart.x+3)*8,types.hutStart.y*8,8,8*2,32*(x+1),32*y,32,32*2)																							
						ctx.drawImage(sprites,(types.hutStart.x+5)*8,types.hutStart.y*8,8,8*2,32*(x+2),32*y,32,32*2)																							
					} else if(field.houseLength == 4){
						ctx.drawImage(sprites,types.hutStart.x*8,types.hutStart.y*8,8,8*2,32*x,32*y,32,32*2)																		
						ctx.drawImage(sprites,(types.hutStart.x+3)*8,types.hutStart.y*8,8*4,8*2,32*(x+1),32*y,32*4,32*2)																							
					} else if(field.houseLength == 5){
						ctx.drawImage(sprites,types.hutStart.x*8,types.hutStart.y*8,8,8*2,32*x,32*y,32,32*2)																		
						ctx.drawImage(sprites,(types.hutStart.x+2)*8,types.hutStart.y*8,8*4,8*2,32*(x+1),32*y,32*4,32*2)																		
					} else if(field.houseLength == 6){
						ctx.drawImage(sprites,types.hutStart.x*8,types.hutStart.y*8,8*6,8*2,32*x,32*y,32*6,32*2)																		
					}
				}
				
				if(field.unit.subType == 'fisher_hut'){
					ctx.drawImage(sprites,types.fisher_hut.x*8,types.fisher_hut.y*8,8,8*2,32*x,32*(y-1),32,32*2)																		
				}
				
				if(field.steps){
					if(field.steps == "fromLeft"){
						ctx.drawImage(sprites,types.stepsRight.x*8,types.stepsRight.y*8,8,8,32*x,32*y,32,32)																		
					}
					if(field.steps == "fromRight"){
						ctx.drawImage(sprites,types.stepsLeft.x*8,types.stepsLeft.y*8,8,8,32*x,32*y,32,32)																		
					}
					if(field.steps == "fromDown"){
						ctx.drawImage(sprites,types.stepsUp.x*8,types.stepsUp.y*8,8,8,32*x,32*y,32,32)																		
					}
					if(field.steps == "fromUp"){
						ctx.drawImage(sprites,types.stepsDown.x*8,types.stepsDown.y*8,8,8,32*x,32*y,32,32)																		
					}
					if(field.steps == "steps"){
						ctx.drawImage(sprites,types.steps.x*8,types.steps.y*8,8,8,32*x,32*y,32,32)																		
					}
				}
				
				if(field.unit.subType == 'twig'){
					X=types.twig.x*8;
					Y=types.twig.y*8;
					ctx.drawImage(sprites,X,Y,8,8,32*x,32*y,32,32)	
				}else if(field.unit.subType == 'unknownInTheSnow'){
					X=types.unknown_item.x*8;
					Y=types.unknown_item.y*8;
					ctx.drawImage(sprites,X,Y,8,8,32*x,32*y,32,32)	
				}else if(field.unit.type == 'corpse'){
					X=types.man.x*8;
					Y=types.man.y*8;
					ctx.drawImage(sprites,X,Y,8,8,32*x,32*y,32,32)	
				}
			}
		}	

		for(var ys=-16; ys<12; ys++){
			for(var xs=-16; xs<12; xs++){
				var field = map.get(Game.player.position.x+xs,Game.player.position.y+ys)									
				var x = 10+xs
				var y = 10+ys		
				X=types.ground.x*8;
				Y=types.ground.y*8;
				ctx.globalAlpha = 1-(snowStorm-Math.min(snowStorm,Math.abs(xs)+Math.abs(ys)))/snowStorm
				ctx.drawImage(sprites,X,Y,8,8,32*x,32*y,32,32)					
			}
		}
		ctx.globalAlpha = 1
		
		if(map.get(Game.player.position.x,Game.player.position.y).type != 7){
			X=types.guy.x*8;
			Y=types.guy.y*8;
			if(Game.player.moving){				
				if(Game.player.movingDirection.y == -1){
					if(Game.player.movingDirection.x == -1){
						AnimatedSprite.all.PLAYER_CHAR_MAN_BACK_LEFT.draw(ctx,box(32*10-Game.player.mapShift.x,32*10-Game.player.mapShift.y,32,32))
					}else{
						AnimatedSprite.all.PLAYER_CHAR_MAN_BACK.draw(ctx,box(32*10-Game.player.mapShift.x,32*10-Game.player.mapShift.y,32,32))
					}
				}else{
					if(Game.player.movingDirection.x == -1){
						AnimatedSprite.all.PLAYER_CHAR_MAN_LEFT.draw(ctx,box(32*10-Game.player.mapShift.x,32*10-Game.player.mapShift.y,32,32))
					}else{
						AnimatedSprite.all.PLAYER_CHAR_MAN.draw(ctx,box(32*10-Game.player.mapShift.x,32*10-Game.player.mapShift.y,32,32))
					}					
				}
			}else{
				ctx.drawImage(sprites,X,Y,8,8,32*10,32*10,32,32)							
			}
		}
		
		ctx.translate(-Game.player.mapShift.x,-Game.player.mapShift.y)
	}
}

var MAP_WIDTH =1000;
var MAP_HEIGHT=1000;

var WIDTH = 21*32;
var HEIGHT= 21*32;

var gameCanvas, gameView, ctx, map, mapDrawer, stepManager, overlayCanvas, mapCanvas;

var keysDown = [];
var passableTypes = [30,31,32,9,0,6,10,100,110,120,130,140,150,160,170,180,190,200,210,11,12,13,14,15,16,17,18,19,20,21,22,61,62,63,64]
var types = {}
var sprites

var Game = {
	time: 0,
	isPassable : function (x,y){
		return arrayContains(map.get(x,y).unit.subType,[Units.EMPTY.subType]) && arrayContains(map.get(x,y).type,passableTypes)
	},
	player : {
		inventory : [],
		moving : false,
		mapShift : p(0,0),
		maxShift : p(32,32),
		position : p(10,10),
		movingDirection : p(0,0),
		startTime : 0,
		startMoving : function(direction){ 			
			this.movingDirection = direction;
			this.startTime = Date.now();
			if(!this.moving){
				var speed = 2
				if(direction.x ==0 || direction.y == 0) speed = 2
				this.mapShift.x += speed*-this.movingDirection.x
				this.mapShift.y += speed*-this.movingDirection.y			
				this.moving = true;
			}
		},
		stopMoving : function(){ 			
			this.movingDirection = p(0,0)
			this.mapShift = p(0,0)
			this.moving = false;
		},
		move : function(){
			if(!this.moving) return
			var speed = 2;
			if(this.movingDirection.x ==0 || this.movingDirection.y == 0) speed = 2
			this.mapShift.x -= speed*this.movingDirection.x
			this.mapShift.y -= speed*this.movingDirection.y
			if(Math.abs(this.mapShift.x) >= this.maxShift.x || Math.abs(this.mapShift.y) >= this.maxShift.y){
				Game.player.position.x = ((Game.player.position.x+this.movingDirection.x+map.width())%map.width())
				Game.player.position.y = ((Game.player.position.y+this.movingDirection.y+map.height())%map.height())
				this.stopMoving();				
			}
		}
	},
	search : {
		unit:null,
		searchIntervalStart: 0,
		searchTimeToDo: 0,
		searchTime : 0,
		outcome : null,
		message : null,
		defaultOutcome : function(){
			this.searchIntervalStart = 0;
			this.searchTime = 0;
			Game.findSomething(Game.search.unit)
		},
		start : function(unit,outcome,text){
			this.message = text || "LET'S SEE IF I CAN FIND SOMETHING";
			this.unit = unit;
			this.searchTime = unit.searchTime;
			this.searchTimeToDo = unit.searchTime;
			this.searchIntervalStart = Game.time;
			this.outcome = outcome;
		},
		update : function(time){
			if(this.searchTimeToDo == 0) return;
			if(time - this.searchIntervalStart > 1000){
				this.searchTimeToDo--
				this.searchIntervalStart = time;
				if(this.searchTimeToDo == 0) {					
					(this.outcome || this.defaultOutcome)(this.unit);
					this.outcome = null;
					this.message = null;
				}
			}				
		},		
		isSearching : function(){
			return this.searchTimeToDo > 0;
		}
	},		
	findSomething : function(unit){
		if(unit.inventory.length == 0){
			Game.setMessage(["THERE'S NOTHING I COULD USE."])
		}
		unit.searched = true;
	},
	currentInterest : null,
	dialog : {
		message : null,
		reset : function() {
			Game.dialog.message = null;
			textPainter.reset();
		},		
	},
	setMessageByField : function(field){					
		Game.currentInterest = null;
		if(field.unit.message || field.unit.canBePickedUp()){			
			Game.currentInterest = field;
			Game.dialog.message = field.unit.message;
		}
	},
	setMessage : function(message, keepCurrentInterest){						
		if(!keepCurrentInterest) Game.currentInterest = null
		Game.dialog.message = message
		textPainter.reset();		
	}	
}

function box(x,y,w,h){	
	return {x:x, y:y, width:w, height:h}	
}

function TextPainter(){
	var textSprite = img('text.png')
	var textPattern = {
		'A' : box(0,0,5,7),
		'B' : box(4,0,5,7),
		'C' : box(8,0,5,7),
		'D' : box(12,0,5,7),
		'E' : box(16,0,5,7),
		'F' : box(20,0,5,7),
		'G' : box(24,0,5,7),
		'H' : box(28,0,5,7),
		'I' : box(32,0,3,7),
		'J' : box(34,0,5,7),
		'K' : box(38,0,5,7),
		'L' : box(42,0,5,7),
		'M' : box(46,0,7,7),
		'N' : box(52,0,5,7),
		'O' : box(56,0,5,7),
		'P' : box(60,0,5,7),
		'Q' : box(64,0,5,7),
		'R' : box(68,0,5,7),
		'S' : box(72,0,5,7),
		'T' : box(76,0,5,7),
		'U' : box(80,0,5,7),
		'V' : box(84,0,5,7),
		'W' : box(88,0,7,7),
		'X' : box(94,0,5,7),
		'Y' : box(98,0,5,7),
		'Z' : box(102,0,5,7),
		'_' : box(106,0,7,7),
		',' : box(112,0,3,7),
		'&' : box(114,0,6,7),
		'!' : box(119,0,3,7),
		'?' : box(121,0,5,7),
		'.' : box(125,0,3,7),
		'`' : box(127,0,6,7),
		'Â´' : box(132,0,6,7),
		'-' : box(137,0,5,7),
		"'" : box(141,0,3,7),
		"[" : box(143,0,4,7),
		"]" : box(146,0,4,7),
		"(" : box(149,0,4,7),
		")" : box(152,0,4,7),
		
	}
	
	this.reset = function(){
		overlayCtx.clearRect(0,0,WIDTH,HEIGHT)
	}
	
	this.drawText = function(text,ctx,x,y){
		var characters = text.split('')
		var xShift=0;
		for(var i=0; i<characters.length; i++){
			var character = characters[i];
			if(textPattern[character]){
				var letter = textPattern[character]
				ctx.drawImage(textSprite,letter.x,letter.y,letter.width,letter.height,x+xShift,y,letter.width*4,letter.height*4)
				xShift+=letter.width*4-4*1
			}else{
				xShift+=5*4;
			}
		}
		y+=7*4	
	}
}

var texts = {
	'ruin' : [
		"THIS PLACE IS COLLAPSED.",
		"THE REMNANTS OF A HOUSE.\nLOOKS LIKE IT COLLAPSED LONG AGO.",
		"ONCE, THIS WAS THE HOME OF SOMEBODY.\nNOW THIS PLACE IS A RUIN."
	],	
	'house' : [
		"SHELTER! FINALLY!\nBUT THE DOOR IS LOCKED.",
		"THIS ONE'S STILL STANDING.\nLET'S HAVE A LOOK INSIDE.",
		"A SAFE PLACE TO HIDE\nFROM THE WIND?"
	],
	'fisher_hut' : [
		"AN OLD AND ABANDONED FISHING HUT.\nAT LEAST SOME TYPE OF SHELTER.",
		"A RAMSHACKLE FISHING HUT.\nKEEPS THE WIND OUTSIDE I HOPE."
	]
}

function splitChoose(arr){
	var msg = arr.rnd()
	return msg?msg.split('\n'):null;
}

function Unit(type,subType,messages, lootable, minSearchTime, maxSearchTime){
	this.type = type;
	this.subType = subType;
	this.message = splitChoose(messages);
	this.inventory = [];
	this.isLootable = function(){
		return lootable || false;
	}
	this.canBePickedUp = function(){return false};
	this.canBeDiggedUp = function(){return false};
	this.searchTime = minSearchTime + w(maxSearchTime-minSearchTime) + 1;
}

function UnitPickupItem(name,subType,messages){
	this.name = name;
	this.type = 'item';
	this.subType = subType;
	this.message = splitChoose(messages);
	this.inventory = [name];
	this.isLootable = function(){return false;}
	this.canBePickedUp = function(){return true};
	this.canBeDiggedUp = function(){return false};
	this.searchTime = 0;
}

function UnitDigUpItem(subType,messages, minSearchTime, maxSearchTime,loot){

	var sum = 0;
	for(var i=0; i<loot.length; i++){
		sum += loot[i].probability
	}
	var r = Math.random()*sum
	var current = 0;
	for(var i=0; i<loot.length; i++){
		if(current + loot[i].probability >= r){
			this.loot = loot[i];
		}
		current += loot[i].probability		
	}	

	this.type = 'item';
	this.subType = subType;
	this.message = splitChoose(messages);
	this.inventory = [name];	
	this.isLootable = function(){return false;}
	this.canBePickedUp = function(){return false};
	this.canBeDiggedUp = function(){return true};
	this.searchTime = this.loot.min + w(this.loot.max-this.loot.min) + 1;
	this.digUp = function(){
		return this.loot.unit();
	}
}

var Units = {
	add : function(type,subType,messages,lootable,minSearchTime,maxSearchTime){
		if(!Units[type]) Units[type] = {}
		if(!Units[type][subType]) Units[type][subType] = function() { return new Unit(type,subType,messages,lootable,minSearchTime,maxSearchTime)};
	},
	addPickupItem : function(name,subType,messages){
		if(!Units['item']) Units['item'] = {}
		if(!Units['item'][subType]) Units['item'][subType] = function() { return new UnitPickupItem(name,subType,messages)};
	},
	addDigUpItem : function(subType,messages,minSearchTime,maxSearchTime,loot){
		if(!Units['item']) Units['item'] = {}
		if(!Units['item'][subType]) Units['item'][subType] = function() { return new UnitDigUpItem(subType,messages,minSearchTime,maxSearchTime,loot)};
	}
}
Units.add('corpse','elder_man'		,["THE FROZEN CORPSE OF AN ELDER MAN.\nWHAT A MESS!"], true,3,10);
Units.add('corpse','elder_women'	,["THE DEAD BODY OF AN ELDER WOMAN.\nI WONDER WHAT HAPPENED TO HER."], true,3,10);
Units.add('corpse','women'			,["SHE'S DEAD.\nWHAT WAS SHE DOING OUT HERE?"], true,3,10);
Units.add('corpse','man'			,["THIS MAN IS DEAD. HE IS FROZEN.\nI CAN'T SEE ANY WOUNDS."], true,3,10);
Units.add('building' ,'house',[
		"SHELTER! FINALLY!\nBUT THE DOOR IS LOCKED.",
		"THIS ONE'S STILL STANDING.\nLET'S HAVE A LOOK INSIDE.",
		"A SAFE PLACE TO HIDE\nFROM THE WIND?"
	]);
Units.add('building' ,'ruin',[
		"THIS PLACE IS COLLAPSED.",
		"THE REMNANTS OF A HOUSE.\nLOOKS LIKE IT COLLAPSED LONG AGO.",
		"ONCE, THIS WAS THE HOME OF SOMEBODY.\nNOW THIS PLACE IS A RUIN."
	]);
Units.add('building' ,'fisher_hut',[
		"AN OLD AND ABANDONED FISHING HUT.\nAT LEAST SOME TYPE OF SHELTER.",
		"A RAMSHACKLE FISHING HUT.\nKEEPS THE WIND OUTSIDE I HOPE."
	]);
Units.add('building' ,'fisher_hut_roof',[
		"AN OLD AND ABANDONED FISHING HUT.\nAT LEAST SOME TYPE OF SHELTER.",
		"A RAMSHACKLE FISHING HUT.\nKEEPS THE WIND OUTSIDE I HOPE."
	]);		
Units.EMPTY = new Unit('empty','empty',[])
Units.STONE = new Unit('landscape','stone',[])
Units.addPickupItem('SMALL BRANCH','twig',[]);//['A SMALL BRANCH',"HERE'S A SMALL BRANCH","A SMALL BRANCH. COULD BE HELPFULL\nSTARTING A FIRE."]);
Units.addDigUpItem('unknownInTheSnow',['THERE IS SOMETHING BENEATH THE SNOW.'],3,6,[
	new Diggable(Units.item.twig,2,3,10),
	new Diggable(Units.corpse.elder_man,4,6,1),
	new Diggable(Units.corpse.elder_women,4,6,1),
	new Diggable(Units.corpse.man,4,6,1),
	new Diggable(Units.corpse.women,4,6,1)]);

function Diggable(unit,min,max,probability){
	this.unit =unit;
	this.min = min;
	this.max=max;
	this.probability=probability;
}

function pressKey(keyCode){
	keysDown[keyCode] = true;
}
function releaseKey(keyCode){
	keysDown[keyCode] = false;
}

var textPainter, overlayCtx;
function start(){
	
	sprites = img('sprites.png')
	
	AnimatedSprite.all.PLAYER_CHAR_MAN = new AnimatedSprite(sprites,[box(1*8,6*8,8,8),box(2*8,6*8,8,8)])
	AnimatedSprite.all.PLAYER_CHAR_MAN_LEFT = new AnimatedSprite(sprites,[box(5*8,7*8,8,8),box(6*8,7*8,8,8)])
	AnimatedSprite.all.PLAYER_CHAR_MAN_BACK = new AnimatedSprite(sprites,[box(1*8,7*8,8,8),box(2*8,7*8,8,8)])
	AnimatedSprite.all.PLAYER_CHAR_MAN_BACK_LEFT = new AnimatedSprite(sprites,[box(3*8,7*8,8,8),box(4*8,7*8,8,8)])
	
	types.guy = p(0,0)
	types.man = p(0,3)
	types.tree1 = p(1,0)
	types.tree2 = p(2,0)
	types.tree3 = p(3,0)
	types.tree4 = p(4,0)
	types.grass = p(5,0)
	types.grass_2 = p(3,6)
	types.grass_3 = p(4,6)
	types.grass_4 = p(5,6)
	types.grass_5 = p(6,6)
	types.twig = p(7,6)
	types.unknown_item = p(8,6)
	
	types.house = p(6,0)
	types.hole = p(7,0)
	types.stepsRight = p(8,0)	
	types.ground = p(9,0)
	types.see = p(10,0)
	types.stepsDown = p(11,0)
	types.stepsUp = p(12,0)
	types.stepsLeft = p(13,0)
	types.steps = p(14,0)
	types.ground_2 = p(15,0)
	types.see_n_w = p(0,1)
	types.see_n_e = p(1,1)
	types.see_s_w = p(2,1)
	types.see_s_e = p(3,1)
	types.see_w = p(4,1)
	types.see_e = p(5,1)
	types.see_e_x = p(6,1)
	types.see_w_x = p(7,1)
	types.see_n_x = p(8,1)
	types.see_s_x = p(9,1)
	types.see_sn_x = p(10,1)
	types.see_we_x = p(11,1)
	types.ground_3 = p(6,3)
	types.ground_4 = p(7,3)
	types.ruin= p(8,3)
	types.speak= p(9,3)
	types.single_lake= p(10,3)
	
	types.hutStart= p(3,4)
	types.mirror_man= p(9,4)
	
	types.fisher_hut= p(10,4)	

	textPainter = new TextPainter();
	
	overlayCanvas = createCanvas(WIDTH,HEIGHT,null,"overlayCanvas")
	gameCanvas = createCanvas(WIDTH,HEIGHT,MouseListener,"gameCanvas")
	mapCanvas = createCanvas(WIDTH,HEIGHT,null,"mapCanvas")
	
	mapCtx = mapCanvas.getContext('2d')
	overlayCtx = overlayCanvas.getContext('2d')
	
	ctx = gameCanvas.getContext("2d");
	
	overlayCtx.mozImageSmoothingEnabled = false;
	overlayCtx.webkitImageSmoothingEnabled = false;
	overlayCtx.msImageSmoothingEnabled = false;
	overlayCtx.imageSmoothingEnabled = false;
	
	mapCtx.mozImageSmoothingEnabled = false;
	mapCtx.webkitImageSmoothingEnabled = false;
	mapCtx.msImageSmoothingEnabled = false;
	mapCtx.imageSmoothingEnabled = false;
	
	ctx.filllStyle = "black"
	ctx.fillRect(0,0,WIDTH,HEIGHT)
	
	document.body.appendChild(gameCanvas)
	document.onkeydown = function(evt){
		var code =  evt.keyCode? evt.keyCode : evt.charCode;
		if(keysDown[code]) return
		var moved = false;		
		
		if(code == KeyCode.LEFT){
			pressKey(KeyCode.LEFT)				
		}
		else if(code == KeyCode.UP){
			pressKey(KeyCode.UP)			
		}
		else if(code == KeyCode.RIGHT){ 
			pressKey(KeyCode.RIGHT)			
		}
		else if(code == KeyCode.DOWN){
			pressKey(KeyCode.DOWN)			
		} else if(code == KeyCode.C){
			pressKey(KeyCode.C)
			if(Game.currentInterest){
				if(Game.currentInterest.unit.isLootable()){
					// SEARCH current interest
					Game.search.start(Game.currentInterest.unit);
				}else if(Game.currentInterest.unit.canBePickedUp()){
					// PICK UP current interest
					Game.currentInterest.unit = Units.EMPTY;
					if(!w(3)) {
						Game.setMessage([['GOT IT!'],['THAT WILL BE USEFUL'],['MIGHT BE USEFUL'],["THAT'LL COME IN HANDY."],['I CAN USE THAT'],['OKAY.'],['GOOD.']].rnd())
					}else{
						Game.dialog.reset()
					}				
				}else if(Game.currentInterest.unit.canBeDiggedUp()){
					// DIG UP current interest									
					Game.search.start(Game.currentInterest.unit, function(){
						var newUnit = Game.currentInterest.unit.digUp()
						Game.currentInterest.unit = newUnit;
						Game.search.unit = newUnit;
						Game.dialog.reset();
						Game.setMessageByField(Game.currentInterest);							
					}, "WHAT HAVE WE HERE?");					
				}else{			
					Game.dialog.reset();
				}
			}else{			
				Game.dialog.reset();
			}
		} else if(code == KeyCode.X){
			pressKey(KeyCode.X)			
			if(Game.dialog.message) {
				Game.dialog.reset();
			}else{
				var messages = [					
					"HUNGRY, THIRSTY, COLD.\nBUT I'M STILL ALIVE.",					
					"_",
					"I WILL SURVIVE THAT DAY.\nAND THE NEXT ONE _ I MUST!",
					"ONE STEP, THEN THE NEXT.\nTHEN THE NEXT _",
				]
				if(snowStorm >= 20){
					messages.push("THE WIND IS MODERATE,\nBUT STILL FREEZING.")
					messages.push("IT WILL GET COLDER SOON.")
				}else {
					messages.push("THAT WIND IS GETTING STRONGER.\nI SHOULD FIND SOME SHELTER SOON.")			
					messages.push("_ SO FREEZING COLD _")
					messages.push("IF ONLY THAT WIND WOULD DROP!")
				}
				
				var houseNear = false;
				for(var ys=-8; ys<9 && !houseNear; ys++){
					for(var xs=-8; xs<9; xs++){
						if(map.get(Game.player.position.x+xs,Game.player.position.y+ys).unit.subType == 'house'){
							houseNear = true;
							break;
						}
					}
				}
				if(houseNear){
					messages.push("I SHOULD GO INSIDE.")
					messages.push("THERE MIGHT BE SOME SUPPLIES LEFT\nIN THERE.")
				}
				Game.dialog.message = messages.rnd().split('\n')
			}
		}
		
		if(arrayContains(code,[37,38,39,40]) && moved){
			var r = w(10);
			if(r==0) {
				snowStorm = Math.min(40, snowStorm+1)				
			}
			if(r==1) {
				snowStorm = Math.max(5, snowStorm-1)				
			}
		}		
	}
	document.onkeyup = function(evt){
		var code =  evt.keyCode? evt.keyCode : evt.charCode;
		keysDown[code] = false;
	}
	
	map = new Map(MAP_WIDTH,MAP_HEIGHT);	
	
	// grass
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.01); i++){
		var x = w(MAP_WIDTH)
		var y = w(MAP_HEIGHT)
		
		for(var n=0; n<5+w(5); n++){
			var xLeft = w(5)			
			for(var X=xLeft; X<4+w(4); X++){
				var field = map.get(x+X,y+n);
				if(field.type != 0) continue;
				if(w(6))field.type = [6,61,62,63,64].rnd();
			}			
		}				
	}
	
	// stones
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.007); i++){
		var field = map.get(w(MAP_WIDTH),w(MAP_HEIGHT))
		field.unit = Units.STONE;
		field.type = 8
	}
	
	// huts
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.0005); i++){
		var x = w(MAP_WIDTH);
		var y = w(MAP_HEIGHT);
		var field = map.get(x,y)		
		
		var skip = false;
		// do not spawn a house in a house				
		
		var len = 3+w(4)
		
		for(var ys=0; ys<2; ys++){
			for(var xs=0; xs<len; xs++){
				if(arrayContains(map.get(x+xs,y+ys).type,[40,7,70])){
					skip = true;
				}
			}
		}
		if(skip) continue;
		
		if(w(3)){
			var house = Units.building.house();
			for(var ys=0; ys<2; ys++){				
				for(var xs=0; xs<len; xs++){
					map.get(x+xs,y+ys).unit = house;
					map.get(x+xs,y+ys).type = 70					
				}
			}
			field.type = 7
			field.houseLength = len;						
		}else{
			field.unit = field.unit = Units.building.ruin();
			field.type = 40;
		}
	}

	// corpse
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.0001); i++){
		var x = w(MAP_WIDTH);
		var y = w(MAP_HEIGHT);
		var field = map.get(x,y)
		if(arrayContains(field.type,passableTypes)){
			men.push(p(x,y));
			var r = w(4)
			if(r==0) map.get(x,y).unit = Units.corpse.elder_man();
			else if(r==1) map.get(x,y).unit = Units.corpse.elder_women();
			else if(r==2) map.get(x,y).unit = Units.corpse.man();
			else if(r==3) map.get(x,y).unit = Units.corpse.women();			
		}
	}

	// wood
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.01); i++){
		var x = w(MAP_WIDTH)
		var y = w(MAP_HEIGHT)
		
		if(x<=10 && x+8>=10 || y<=10 && y+10 >= 10) continue				
		
		for(var n=0; n<5+w(5); n++){
			var xLeft = w(5)			
			for(var X=xLeft; X<4+w(4); X++){				
				var field = map.get(x+X,y+n);
				if(arrayContains(field.type,[40,7,70])) continue;
				if(field.type != 0) continue;
				if(w(6)) field.type = [2,3,4,5].rnd();
				else if(!w(3)) field.type = 6
			}			
		}				
	}
		
	// lake
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.01); i++){
		var x = w(MAP_WIDTH)
		var y = w(MAP_HEIGHT)
		
		if(x<=10 && x+8>=10 || y<=10 && y+10 >= 10) continue
		
		var drawFisherHut = !w(20)
		
		for(var n=0; n<5+w(5); n++){
			var xLeft = w(2)			
			var xMax = 3+w(5);
			for(var X=xLeft; X<xMax; X++){
				var field = map.get(x+X,y+n);				
				if(arrayContains(field.type,[40,7,70,8])) continue;
				field.type = 9
				if(drawFisherHut && !w(10) && X != xLeft && X != xMax-1 && map.get(x+X,y+n-1).type == 9){
					field.unit = Units.building.fisher_hut();
					map.get(x+X,y+n-1).unit = Units.building.fisher_hut_roof();
					map.get(x+X,y+n-1).unit.message = field.unit.message					
					drawFisherHut = false
				}
			}			
		}				
	
	}
	
	// lake banks
	var todo = [];	
	for(var y=0; y<map.height(); y++){
		for(var x=0; x<map.width(); x++){
			var field = map.get(x,y);
			if(field.type == 9){
				if(map.get(x-1,y).type != 9 && map.get(x,y-1).type != 9 && map.get(x,y+1).type != 9 && map.get(x+1,y).type != 9) field.type = 22
				else if(map.get(x-1,y).type != 9 && map.get(x,y-1).type != 9 && map.get(x,y+1).type != 9) todo.push([x,y,14])
				else if(map.get(x+1,y).type != 9 && map.get(x,y-1).type != 9 && map.get(x,y+1).type != 9) todo.push([x,y,15])
				else if(map.get(x-1,y).type != 9 && map.get(x,y-1).type != 9) todo.push([x,y,[10,100].rnd()])
				else if(map.get(x-1,y).type != 9 && map.get(x,y+1).type != 9) todo.push([x,y,[12,120].rnd()])
				else if(map.get(x+1,y).type != 9 && map.get(x,y-1).type != 9) todo.push([x,y,[11,110].rnd()])
				else if(map.get(x+1,y).type != 9 && map.get(x,y+1).type != 9) todo.push([x,y,[13,130].rnd()])
				else if(map.get(x,y+1).type != 9 && map.get(x,y-1).type != 9) todo.push([x,y,[20,200].rnd()])
				else if(map.get(x+1,y).type != 9 && map.get(x-1,y).type != 9) todo.push([x,y,[21,210].rnd()])
				else if(map.get(x-1,y).type != 9) todo.push([x,y,[16,160].rnd()])
				else if(map.get(x+1,y).type != 9) todo.push([x,y,[17,170].rnd()])
				else if(map.get(x,y-1).type != 9) todo.push([x,y,[18,180].rnd()])
				else if(map.get(x,y+1).type != 9) todo.push([x,y,[19,190].rnd()])
			}
			else if(field.type == 0 && !w(16)){
				var r = w(3);
				if(r==0) field.type = 30
				else if(r==1) field.type = 31
				else if(r==2) field.type = 32
			}
		}
	}
		
	for(var i=0; i<todo.length; i++){
		var field = map.get(todo[i][0],todo[i][1]);
		field.type = todo[i][2]
		if(!arrayContains(field.unit.subType,['fisher_hut','fisher_hut_roof'])){
			field.unit = Units.EMPTY			
		}
	}		
	
	// items
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.006); i++){
		var field = map.get(w(MAP_WIDTH),w(MAP_HEIGHT))
		if(field.type != 0) continue;
		
		field.unit = Units.item.twig();				
	}
	
	// hidden items
	for(var i=0; i<Math.floor((MAP_WIDTH*MAP_HEIGHT)*0.0005); i++){
		var field = map.get(w(MAP_WIDTH),w(MAP_HEIGHT))
		if(field.type != 0) continue;
		
		field.unit = Units.item.unknownInTheSnow();		
	}
	
	map.get(10,10).type = 0
	
	mapDrawer = new MapDrawer(mapCanvas.getContext("2d"), map, stepManager)
	
	MouseListener.registeredClients.mouseDown.push(mapDrawer)
	MouseListener.registeredClients.mouseMove.push(mapDrawer)
		
	window.requestAnimationFrame(tick)
}

var fieldSize = p(16,16);

function drawMouse(){
	var overlayContext = overlayCanvas.getContext("2d");
	overlayContext.clearRect(0,0,WIDTH,HEIGHT)
	if(mapDrawer.currentMousePosition){		
		overlayContext.fillStyle = "rgba(255,255,255,0.5)";
		var size = 1;		
		overlayContext.fillRect(fieldSize.x*mapDrawer.currentMousePosition.x,fieldSize.y*mapDrawer.currentMousePosition.y,fieldSize.x*size,fieldSize.y*size)
	}
}

var KeyCode = {
	LEFT : 37,
	UP : 38,
	RIGHT : 39,
	DOWN : 40,
	C : 67,
	X : 88,	
}

var men = [];
var lastTime = 0;
var stepTime = 50;
var lastAnimationTime = 0;
var animationStepTime = 250;
function tick(time){
	Game.time = time;
	if(time-lastTime > stepTime){
		lastTime = time;			
		mapDrawer.draw();					
	}			
	if(time-lastAnimationTime > animationStepTime){
		lastAnimationTime = time;	
		AnimatedSprite.all.PLAYER_CHAR_MAN.tick()		
		AnimatedSprite.all.PLAYER_CHAR_MAN_LEFT.tick()		
		AnimatedSprite.all.PLAYER_CHAR_MAN_BACK.tick()		
		AnimatedSprite.all.PLAYER_CHAR_MAN_BACK_LEFT.tick()
	}		
	
	if(Game.player.moving){
		Game.player.move();
	}		
	
	// diagonal movement
	if((keysDown[KeyCode.LEFT] || keysDown[KeyCode.RIGHT]) && (keysDown[KeyCode.UP] ||  keysDown[KeyCode.DOWN])){		
		var direction;
		if(keysDown[KeyCode.LEFT] && keysDown[KeyCode.UP]) {
			direction = p(-1,-1)				
		}else if(keysDown[KeyCode.LEFT] && keysDown[KeyCode.DOWN]) {
			direction = p(-1,1)				
		}else if(keysDown[KeyCode.RIGHT] && keysDown[KeyCode.UP]) {
			direction = p(1,-1)				
		}else{
			direction = p(1,1)				
		}
		
		if(!Game.isPassable(Game.player.position.x+direction.x,Game.player.position.y+direction.y)){
			if(Game.dialog.message){
				Game.dialog.reset();				
			}	
			Game.setMessageByField(map.get(Game.player.position.x+direction.x,Game.player.position.y+direction.y));			
			
			if(Game.isPassable(Game.player.position.x,Game.player.position.y+direction.y)){
				direction.x = 0
			}else{
				direction.y = 0
			}
		}
		
		if(Game.isPassable(Game.player.position.x+direction.x,Game.player.position.y+direction.y)){
			map.get(Game.player.position.x,Game.player.position.y).steps = "steps";
			Game.player.startMoving(direction)
			Game.dialog.reset();				
		}else {		
			if(Game.dialog.message){
				Game.dialog.reset();				
			}	
			Game.setMessageByField(map.get(Game.player.position.x+direction.x,Game.player.position.y+direction.y));			
		}
	} else if(!Game.player.moving){
		if(keysDown[KeyCode.LEFT] && !Game.player.moving){		
			if(Game.isPassable(Game.player.position.x-1,Game.player.position.y)){
				if(map.get(Game.player.position.x,Game.player.position.y).steps || !map.get(Game.player.position.x+1,Game.player.position.y).steps){
					map.get(Game.player.position.x,Game.player.position.y).steps = "steps";
				}else{
					map.get(Game.player.position.x,Game.player.position.y).steps = "fromRight";
				}
				Game.player.startMoving(p(-1,0))
				Game.dialog.reset();		
				Game.setMessageByField(map.get(Game.player.position.x-1,Game.player.position.y));					
			}else {
				if(Game.dialog.message){
					Game.dialog.reset();				
				}	
				Game.setMessageByField(map.get(Game.player.position.x-1,Game.player.position.y));			
			}
		} else if(keysDown[KeyCode.RIGHT] && !Game.player.moving){		
			if(Game.isPassable(Game.player.position.x+1,Game.player.position.y)){
				if(map.get(Game.player.position.x,Game.player.position.y).steps || !map.get(Game.player.position.x-1,Game.player.position.y).steps){
					map.get(Game.player.position.x,Game.player.position.y).steps = "steps";
				}else{
					map.get(Game.player.position.x,Game.player.position.y).steps = "fromLeft";
				}
				Game.player.startMoving(p(1,0))
				Game.dialog.reset();				
				Game.setMessageByField(map.get(Game.player.position.x+1,Game.player.position.y));	
			}else {
				if(Game.dialog.message){
					Game.dialog.reset();				
				}	
				Game.setMessageByField(map.get(Game.player.position.x+1,Game.player.position.y));			
			}		
		} else if(keysDown[KeyCode.UP] && !Game.player.moving){		
			if(Game.isPassable(Game.player.position.x,Game.player.position.y-1)){
				if(map.get(Game.player.position.x,Game.player.position.y).steps || !map.get(Game.player.position.x,Game.player.position.y+1).steps){
					map.get(Game.player.position.x,Game.player.position.y).steps = "steps";
				}else{
					map.get(Game.player.position.x,Game.player.position.y).steps = "fromDown";
				}
				Game.player.startMoving(p(0,-1))
				Game.dialog.reset();				
				Game.setMessageByField(map.get(Game.player.position.x,Game.player.position.y-1));
			}else {
				if(Game.dialog.message){
					Game.dialog.reset();				
				}	
				Game.setMessageByField(map.get(Game.player.position.x,Game.player.position.y-1));			
			}		
		} else if(keysDown[KeyCode.DOWN] && !Game.player.moving){		
			if(Game.isPassable(Game.player.position.x,Game.player.position.y+1)){
				if(map.get(Game.player.position.x,Game.player.position.y).steps || !map.get(Game.player.position.x,Game.player.position.y-1).steps){
					map.get(Game.player.position.x,Game.player.position.y).steps = "steps";
				}else{
					map.get(Game.player.position.x,Game.player.position.y).steps = "fromUp";
				}
				Game.player.startMoving(p(0,1))
				Game.dialog.reset();				
				Game.setMessageByField(map.get(Game.player.position.x,Game.player.position.y+1));
			}else {
				if(Game.dialog.message){
					Game.dialog.reset();				
				}	
				Game.setMessageByField(map.get(Game.player.position.x,Game.player.position.y+1));			
			}
		}
	}	
		
	Game.search.update(time)
	if(Game.search.isSearching()){	
		var n = Game.search.searchTime - Game.search.searchTimeToDo + 1 	
		Game.setMessage([Game.search.message,"",""," ".repeat(Math.floor(Game.search.searchTime/3))+"["+"I".repeat(n)+".".repeat(Game.search.searchTimeToDo-1)+"]"],true)		
	}
		
	if(Game.dialog.message){			

		overlayCtx.fillStyle = "#21262b"
		overlayCtx.fillRect(0,13*32-5-1*4,WIDTH,100)
		overlayCtx.fillStyle = "#e0f0f0"
		overlayCtx.fillRect(0,13*32-5,WIDTH,100- 2*4)
	
		overlayCtx.drawImage(sprites,types.speak.x*8,types.speak.y*8,8,8,10*32,12*32-1*5,32,32)
		for(var message of Game.dialog.message){
			textPainter.drawText(message,overlayCtx,Math.floor(WIDTH/2-message.length*8),13*32+10+(7*4)*Game.dialog.message.indexOf(message));
		}
		
		if(!Game.search.isSearching()){
			if(Game.currentInterest && (Game.currentInterest.unit.isLootable() || Game.currentInterest.unit.canBeDiggedUp()) && !Game.currentInterest.unit.searched){
				overlayCtx.fillStyle = "#21262b"
				overlayCtx.fillRect(2*32,16*32+8,6*32,32+16)
				overlayCtx.fillStyle = "#e0f0f0"
				overlayCtx.fillRect(2*32+4,16*32+8+4,6*32-8,32+16-8)
				textPainter.drawText("(X) IGNORE",overlayCtx,2*32+16,16*32+18);
			
				overlayCtx.fillStyle = "#21262b"
				overlayCtx.fillRect(13*32,16*32+8,6*32,32+16)
				overlayCtx.fillStyle = "#e0f0f0"
				overlayCtx.fillRect(13*32+4,16*32+8+4,6*32-8,32+16-8)
				if(Game.currentInterest.unit.isLootable()){
					textPainter.drawText("(C) SEARCH",overlayCtx,13*32+16,16*32+18);
				}else{
					textPainter.drawText("(C) DIG UP",overlayCtx,13*32+16,16*32+18);
				}
			}
		}
	}
	
	if(Game.currentInterest && Game.currentInterest.unit.canBePickedUp() && !Game.search.isSearching()){
		var size = Math.ceil(Game.currentInterest.unit.name.length/1.5);
		overlayCtx.fillStyle = "#21262b"
		overlayCtx.fillRect((8-Math.floor(size/2))*32,12*32,6*32+size*32,32+16)
		overlayCtx.fillStyle = "#e0f0f0"
		overlayCtx.fillRect((8-Math.floor(size/2))*32+4,12*32+4,6*32-8+size*32,32+16-8)
		textPainter.drawText("(C) PICK UP "+Game.currentInterest.unit.name,overlayCtx,(8-Math.floor(size/2))*32+16,12*32+10);
	}
	
	ctx.drawImage(mapCanvas,0,0)
	ctx.drawImage(overlayCanvas,0,0)

	window.requestAnimationFrame(tick)
}


</script>

<style>
canvas {
    image-rendering: optimizeSpeed;             // Older versions of FF
    image-rendering: -moz-crisp-edges;          // FF 6.0+
    image-rendering: -webkit-optimize-contrast; // Safari
    image-rendering: -o-crisp-edges;            // OS X & Windows Opera (12.02+)
    image-rendering: pixelated;                 // Awesome future-browsers
    -ms-interpolation-mode: nearest-neighbor;   // IE
}
</style>
</head>
<body onload="start()" style="background-color:black">
<pre style="color:white">
arrow keys --- move character
x ------------ talk / cancel talk
</pre>
</body></html>